<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Coffee Sales in Numebers</title>

    <link rel="stylesheet" href="css/dc.css">

</head>
<body>
    <h1>Coffee Sales Analytics</h1>

    <div id="origin"></div>
    <div id="blend"></div>
    <div id="roastLevel"></div>
    <div id="seasonal"></div>
    <div id="year"></div>
    <div id="originHeatMap"></div>


    <script type="text/javascript" src="js/d3.js"></script>
    <script type="text/javascript" src="js/crossfilter.js"></script>
    <script type="text/javascript" src="js/dc.js"></script>
    <script>

        // using # to refer the id in <div>
        var originChart = dc.rowChart("#origin");
        var blendChart = dc.pieChart("#blend");
        var roastLevelChart = dc.pieChart("#roastLevel");
        var seasonalChart = dc.pieChart("#seasonal");
        var yearChart = dc.pieChart("#year");
        var originHeatMapChart = dc.heatMap("#originHeatMap")



        d3.csv("b2c.csv", function (err, data){
            if (err) throw err;

            //created_at,origin,blend,roast_level,type,unit_price,lbs
            //2014-01-06 13:53:28,Panama,Single,light,Seasonal,32.4,1.5
            //2014-01-13 20:09:09,Panama,Single,light,Seasonal,32.4,0.75


            data.forEach(function (d) {
               d.created_at = new Date(d.created_at);
               d.unit_price = +d.unit_price;
               d.lbs = +d.lbs;
            });

            var ndx = crossfilter(data);
            var all = ndx.groupAll();

            // how many categorical features are here to be used as filters
            var dateDim = ndx.dimension(function (d) {return d["created_at"];});
            var yearlyDim = ndx.dimension(function (d) {return d["created_at"].getFullYear();});
            var monthlyDim = ndx.dimension(function (d) {return d["created_at"].getMonth();});
            var originDim = ndx.dimension(function (d) {return d["origin"];});
            var blendDim = ndx.dimension(function (d) {return d["blend"];});
            var roastLevelDim = ndx.dimension(function (d) {return d["roast_level"];});
            var seasonalDim = ndx.dimension(function (d) {return d["type"];});
            var monthOriginDim = ndx.dimension(
                function (d) {
                    return [d.created_at.getMonth(), d.created_at.getFullYear()];
                }
            );

            // group of categorical features
            var yearlyGroup = yearlyDim.group().reduceSum(function (d) {return d.lbs;});
            var originGroup = originDim.group().reduceSum(function (d) {return d.lbs;});
            var blendGroup = blendDim.group().reduceSum(function (d) {return d.lbs;});
            var roastLevelGroup = roastLevelDim.group().reduceSum(function (d) {return d.lbs;});
            var seasonalGroup = seasonalDim.group().reduceSum(function (d) {return d.lbs;});
            var sumMonthOriginGroup = monthOriginDim.group().reduceSum(function (d) {return d.lbs;});

            originChart
                .height(500)
                .dimension(originDim)
                .group(originGroup)
                .data(function (group) {return group.top(10); })
                .elasticX(true);

            blendChart
                .dimension(blendDim)
                .group(blendGroup)
                .on('pretransition', function(chart) {
                    chart.selectAll('text.pie-slice').text(function(d) {
                    return d.data.key + ' ' + dc.utils.printSingleValue((d.endAngle - d.startAngle) / (2*Math.PI) * 100) + '%';
                    })
                });

            roastLevelChart
                .dimension(roastLevelDim)
                .group(roastLevelGroup)
                .on('pretransition', function(chart) {
                    chart.selectAll('text.pie-slice').text(function(d) {
                    return d.data.key + ' ' + dc.utils.printSingleValue((d.endAngle - d.startAngle) / (2*Math.PI) * 100) + '%';
                    })
                });

            seasonalChart
                .dimension(seasonalDim)
                .group(seasonalGroup)
                .on('pretransition', function(chart) {
                    chart.selectAll('text.pie-slice').text(function(d) {
                    return d.data.key + ' ' + dc.utils.printSingleValue((d.endAngle - d.startAngle) / (2*Math.PI) * 100) + '%';
                    })
                });

            yearChart
                .dimension(yearlyDim)
                .group(yearlyGroup);


            originHeatMapChart
                .width(12 * 80 + 80)
                .height(27 * 10 + 40)
                .dimension(monthOriginDim)
                .group(sumMonthOriginGroup)
                .keyAccessor(function(d) { return +d.key[0]; })
                .valueAccessor(function(d) { return +d.key[1]; });
//                .colorAccessor(function(d) { return +d.value; });

            originHeatMapChart.xBorderRadius(0);
            originHeatMapChart.yBorderRadius(0);

            dc.renderAll();

        })
    </script>
</body>
</html>
